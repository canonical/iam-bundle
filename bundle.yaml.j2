---
{%- set testing = testing is defined and testing.casefold() in ["1", "yes", "true"] %}
bundle: kubernetes
name: iam
applications:
  hydra:
    charm: hydra
    channel: {{ channel|default('edge', true) }}
    scale: 1
    series: jammy
    trust: true
  kratos:
    charm: kratos
    channel: {{ channel|default('edge', true) }}
    scale: 1
    series: jammy
    trust: true
  kratos-external-idp-integrator:
    charm: kratos-external-idp-integrator
    channel: {{ channel|default('edge', true) }}
    scale: 1
    series: jammy
# TODO: Uncomment when https://github.com/canonical/kratos-ui-operator is published
#  identity-platform-login-ui:
#    charm: identity-platform-login-ui
#    channel: {{ channel|default('edge', true) }}
#    scale: 1
#    series: jammy
  postgresql-k8s:
    charm: postgresql-k8s
    channel: edge
    series: jammy
    scale: 1
    trust: true
  tls-certificates-operator:
    charm: tls-certificates-operator
    channel: stable
    scale: 1
    {%- if testing %}
    options:
      ca-common-name: test-domain
      generate-self-signed-certificates: true
    {%- endif %}
  traefik-admin:
    charm: traefik-k8s
    channel: edge
    series: focal
    scale: 1
  traefik-public:
    charm: traefik-k8s
    channel: edge
    series: focal
    scale: 1
relations:
  - [hydra:pg-database, postgresql-k8s:database]
  - [kratos:pg-database, postgresql-k8s:database]
  - [kratos:endpoint-info, hydra:endpoint-info]
  - [kratos-external-idp-integrator:kratos-external-idp, kratos:kratos-external-idp]
  - [hydra:admin-ingress, traefik-admin:ingress]
  - [hydra:public-ingress, traefik-public:ingress]
  - [kratos:admin-ingress, traefik-admin:ingress]
  - [kratos:public-ingress, traefik-public:ingress]
# TODO: Uncomment when https://github.com/canonical/kratos-ui-operator is published
#  - [identity-platform-login-ui:ingress, traefik-public:ingress]
  - [traefik-admin:certificates, tls-certificates-operator:certificates]
  - [traefik-public:certificates, tls-certificates-operator:certificates]
